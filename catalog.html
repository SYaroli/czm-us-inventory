<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CZM Inventory — Catalog</title>
  <link rel="icon" href="czm-logo.png">
  <style>
    :root{--bg:#0e0f12;--panel:#14151a;--card:#17181d;--ink:#e9e9ee;--muted:#a2a6b3;--accent:#d71b2b;--line:#23242a;--good:#37c978;--bad:#ff6b6b;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .top{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line);background:var(--panel);position:sticky;top:0;z-index:10}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:36px;width:auto;object-fit:contain;display:block}
    .brand h1{font-size:18px;margin:0}
    .actions{display:flex;align-items:center;gap:10px}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .pill{border:0;background:var(--accent);color:#fff;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer}
    main{padding:14px}
    .filters{display:grid;grid-template-columns:1.4fr .8fr;gap:8px;margin:12px 0}
    .summary{display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:13px;margin-bottom:8px}
    table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px;vertical-align:top}
    th{white-space:nowrap}
    td:first-child, td:last-child{white-space:nowrap}
    tbody tr:hover{background:#1b1c22}
    .right{text-align:right}
    .qty{font-weight:800}
    .qty.pos{color:var(--good)} .qty.neg{color:var(--bad)} .qty.zero{color:var(--muted)}
    a.item{color:inherit;text-decoration:none}
    a.item:hover{text-decoration:underline}
    .muted{color:var(--muted)}
    .noauth{padding:16px}
  </style>
</head>
<body>
  <header class="top">
    <div class="brand">
      <img src="czm-logo.png" alt="CZM">
      <h1>CZM Inventory</h1>
    </div>
    <div class="actions">
      <span id="hello" class="badge"></span>
      <button class="pill" id="exportCsv">Export CSV</button>
      <button class="pill" id="signout">Sign out</button>
    </div>
  </header>

  <main>
    <div class="filters">
      <input id="q" placeholder="Search Item or Description"/>
      <select id="wh"><option value="">All Warehouses</option></select>
    </div>

    <div class="summary" id="summary"></div>

    <table id="grid">
      <thead>
        <tr>
          <th style="width:220px;cursor:pointer" data-sort="Item">Item ▾</th>
          <th>Description</th>
          <th class="right" style="width:130px;cursor:pointer" data-sort="Qty On Hand">Qty On Hand ▾</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p class="muted" style="margin-top:8px">Data loads from <code>catalog.js</code> (Infor CSV export). Click an Item to open its inventory page.</p>
  </main>

  <script>
    // Session check
    let session=null; try{session=JSON.parse(localStorage.getItem('czm_session')||'null')}catch{}
    if(!session||!session.username){document.body.innerHTML='<div class="noauth"><p class="muted">Not signed in.</p><p><a href="index.html" class="pill" style="text-decoration:none;padding:8px 12px;">Go to sign in</a></p></div>';throw new Error('unauth')}
    document.getElementById('hello').textContent=(session.name||session.username)+(session.role?` • ${session.role}`:"");
    document.getElementById('signout').onclick=()=>{localStorage.removeItem('czm_session');location.href='index.html';};
  </script>

  <script src="catalog.js"></script>
  <script>
    const raw = (typeof CATALOG!=='undefined')?CATALOG:[];
    const data = raw.map(normalizeRecord);

    function normalizeRecord(r){
      return {
        "Item": String(r["Item"]||""),
        "Description": String(r["Description"]||""),
        "Qty On Hand": Number(r["Qty On Hand"]||0),
        "Warehouse": String(r["Warehouse"]||"")
      };
    }

    const qs=id=>document.getElementById(id);
    const unique=a=>[...new Set(a.filter(Boolean))].sort((x,y)=>x.localeCompare(y));
    const sum=(arr,k)=>arr.reduce((t,x)=>t+(+x[k]||0),0);
    const esc=s=>String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

    // Build warehouse list
    for(const w of unique(data.map(x=>x["Warehouse"]))) qs('wh').insertAdjacentHTML('beforeend', `<option>${esc(w)}</option>`);

    let sortKey="Item", sortDir=1;
    qs('q').addEventListener('input', render);
    qs('wh').addEventListener('change', render);
    document.querySelectorAll('th[data-sort]').forEach(th=>{
      th.addEventListener('click',()=>{const k=th.getAttribute('data-sort'); if(sortKey===k) sortDir*=-1; else{sortKey=k;sortDir=1;} render();});
    });

    function norm(s){
      return String(s || "").toLowerCase().replace(/[^a-z0-9]+/g, "");
    }
    function matches(qn, item, desc){
      if(!qn) return true;
      const i = norm(item), d = norm(desc);
      if(i.includes(qn) || d.includes(qn)) return true;
      const q2 = qn.replace(/0+$/,""); // allow extra trailing zeros
      if(q2 && (i.includes(q2) || d.includes(q2))) return true;
      return false;
    }

    function render(){
      const qRaw = qs('q').value;
      const fwh = qs('wh').value;
      const qn = norm(qRaw.trim());

      let rows=data.filter(r=>{
        if(qn && !matches(qn, r["Item"], r["Description"])) return false;
        if(fwh && r["Warehouse"]!==fwh) return false;
        return true;
      });

      // store filtered rows for export
      window._lastRows = rows;

      rows.sort((a,b)=> sortKey==="Qty On Hand" ? (a[sortKey]-b[sortKey])*sortDir : String(a[sortKey]).localeCompare(String(b[sortKey]))*sortDir);

      // Summary
      qs('summary').innerHTML = `
        <span class="badge">Items: ${rows.length.toLocaleString()}</span>
        <span class="badge">Total Qty: ${sum(rows,"Qty On Hand").toLocaleString()}</span>
        ${fwh? `<span class="badge">Warehouse: ${esc(fwh)}</span>`:""}
      `;

      // Rows
      const tb=document.querySelector('#grid tbody');
      tb.innerHTML = rows.map(r=>{
        const qty=r["Qty On Hand"]; const cls=qty>0?'pos':qty<0?'neg':'zero';
        const link=`item.html?item=${encodeURIComponent(r["Item"])}`;
        return `
          <tr>
            <td><a class="item" href="${link}"><code>${esc(r["Item"])}</code></a></td>
            <td><a class="item" href="${link}">${esc(r["Description"])}</a></td>
            <td class="right qty ${cls}">${qty.toLocaleString()}</td>
          </tr>
        `;
      }).join('');
    }

    // Export CSV (filtered view)
    document.getElementById('exportCsv').addEventListener('click', exportCsv);

    function exportCsv(){
      const rows = (window._lastRows && window._lastRows.length) ? window._lastRows : data;
      if (!rows.length) { alert('Nothing to export.'); return; }

      // Columns to export (matches list view)
      const cols = ["Item","Description","Qty On Hand","Warehouse"];

      const csv = toCSV(rows, cols);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const a = document.createElement('a');
      const ts = new Date().toISOString().replace(/[-:]/g,'').slice(0,15);
      a.download = `czm-inventory_${ts}.csv`;
      a.href = URL.createObjectURL(blob);
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    function toCSV(rows, cols){
      const escCell = v => `"${String(v ?? "").replace(/"/g,'""').replace(/\r?\n/g,' ')}"`;
      const header = cols.map(escCell).join(',');
      const lines = rows.map(r => cols.map(c => {
        let v = r[c];
        if (typeof v === 'boolean') v = v ? 'true' : 'false';
        return escCell(v);
      }).join(','));
      return [header, ...lines].join('\r\n'); // CRLF for Excel
    }

    render();
  </script>
</body>
</html>
